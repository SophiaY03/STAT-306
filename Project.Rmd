---
title: 'STAT 306 Project'
author: 'Sophia Yang (33176769), '
date: "13 April, 2023"
output:
  pdf_document: default
  html_document: default
---

```{r}
library(dplyr)
library(tidyverse)
library(RColorBrewer)
library(GGally)
library(cowplot)
library(mltools)
library(leaps)
```

## Introduction

We will be using the sleep efficiency dataset:

https://www.kaggle.com/datasets/equilibriumm/sleep-efficiency in Kaggle, which contains 100 observations.

The data was collected in 2021 by a research team in the UK, and was collected from the University of Oxfordshire. It was collected from a local community over a period of several months using a combination of self-reported surveys, actigraphy, and polysomnography (a sleep monitoring technique). 

**Our research question and motivation behind the analysis of the data:**

Which variables are most important in predicting sleep efficiency? And how do these variables relate to sleep efficiency?

We use a forward selection process to determine which variables are most relevant for predicting sleep efficiency and build regression models based only on the variables selected. After comparing different models, we select the best model and use this model to predict the test dataset and combine it with the actual values to see how accurate our model is.

From the model, we can develop a general idea about what factors relate to sleep efficiency and how they are correlated. Therefore, it may suggest some methods to improve sleep patterns by controlling certain factors. 

```{r}
sleep <- read.csv('Sleep_Efficiency.csv')

# Convert certain variables into categorical variables 
# Gender: male is encoded as 1, and female is encoded as 0
# Smoking status: Yes is encoded as 1, and No is encoded as 0
sleep <- sleep |>
    mutate(Caffeine.consumption = as.factor(Caffeine.consumption),
          Awakenings = as.factor(Awakenings),
          Alcohol.consumption = as.factor(Alcohol.consumption), 
          Smoking.status = as.factor(case_when(
              Smoking.status == 'Yes' ~ 1,
              Smoking.status == 'No' ~ 0,
              TRUE ~ NA)),
           Gender= as.factor(case_when(
              Gender == 'Male' ~ 1,
              Gender == 'Female' ~ 0,
              TRUE ~ NA)),
           Exercise.frequency = as.factor(Exercise.frequency)
          )

head(sleep)
```

We include 12 variables:

*The response variable:*

>Sleep efficiency: a numerical variable ranging from 0 to 1 that indicates the proportion of time in bed spent asleep

*The explanatory variables are:*

>1. Age: numerical variable ranges from 9 to 69
2. Gender: categorical / dummy variable with 50% of the data is male and the rest half female
3. Sleep duration: numerical variable indicating the total amount of time the test subject slept (in hours).
4. Awakenings: categorical variable indicating the number of times the test subject wakes up during the night
5. REM sleep percentage: numerical variable indicating the percentage of total sleep time spent in REM (rapid eye movement) sleep 
    - REM sleep is the stage where people have intense brain activities (dreams) and restores the areas of the brain that help with memory and learning. 20% of the total sleep time in the REM stage is considered good 
>6. Deep sleep percentage: numerical variable indicating the percentage of total sleep time spent in Deep (non - rapid eye movement) sleep 
    - Deep sleep is important for body to replenish energy stores and repair muscles, bones, and tissue. 15% to 25% of the total sleep time in the deep sleep stage is considered normal  
>7. Light sleep percentage:  numerical variable indicating the percentage of total sleep time spent in Light sleep
    - Light sleep is the transitional stage between waking and sleeping. Typically take up about 50% to 60% or more of the total sleep time     
>8. Caffeine consumption: categorical variable indicating the amount of caffeine consumed in the 24 hours prior to bedtime (in mg)
9. Alcohol consumption: categorical variable indicating the amount of alcohol consumed in the 24 hours prior to bedtime (in oz)
10. Smoking status: categorical / dummy variable that states whether or not the person smokes
11. Exercise frequency: categorical variable indicating the number of times the person exercises each week

Although some explanatory variables seem to be numerical (e.g., Alcohol consumption, Caffeine consumption), the number of values that these variables take is limited; therefore, we can view these variables as categorical with a few levels. 

```{r}
sleep_data <- sleep |>
    select(-ID, -Bedtime, -Wakeup.time)
head(sleep_data)
```

```{r}
set.seed(1)

train_ind <- sample.int(nrow(sleep_data), size = nrow(sleep_data) * 0.70, replace = F)

sleep_train <- sleep_data[train_ind,]
sleep_test <- sleep_data[-train_ind,]
```

```{r}
options(repr.plot.height = 15, repr.plot.width = 20)
gender_dist <- sleep_train |>
    ggplot(aes(x = Gender)) +
    geom_bar() +
    ylab('') +
    theme(text = element_text(size = 12))

awaken_dist <- sleep_train |>
    ggplot(aes(x = Awakenings)) +
    geom_bar() +
    ylab('') +
    theme(text = element_text(size = 12))

coffee_dist <- sleep_train |>
    ggplot(aes(x = Caffeine.consumption)) +
    geom_bar() +
    ylab('') +
    theme(text = element_text(size = 12))

alcohol_dist <- sleep_train |>
    ggplot(aes(x = Alcohol.consumption)) +
    geom_bar() +
    ylab('') +
    theme(text = element_text(size = 12))

smoke_dist <- sleep_train |>
    ggplot(aes(x = Smoking.status)) +
    geom_bar() +
    ylab('') +
    theme(text = element_text(size = 12))

exercise_dist <- sleep_train |>
    ggplot(aes(x = Exercise.frequency)) +
    geom_bar() +
    ylab('') +
    theme(text = element_text(size = 12))

# plot 6 barplots in one graph
plot_row <- plot_grid(gender_dist, awaken_dist, coffee_dist, alcohol_dist, smoke_dist, 
          exercise_dist, nrow = 2)

# now add the title
title <- ggdraw() + 
  draw_label(
    "Distributions",
    fontface = 'bold',
    x = 0,
    hjust = 0
  ) +
  theme(
    # add margin on the left of the drawing canvas,
    # so title is aligned with left edge of first plot
    plot.margin = margin(0, 0, 0, 7)
  )
plot_grid(
  title, plot_row,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.1, 1)
)
```
Here we explore the distributions of all categorical explanatory variables. We see that we have roughly the same number of people for each gender and have the number of nonsmokers twice as large as that of smokers. Awakenings and exercise frequency are more evenly distributed, while caffeine consumption and alcohol consumption are skewed to the right. 

```{r}
options(repr.plot.height = 20, repr.plot.width = 20)
sleep_train |>
    ggpairs(columns = c('Age', 'Sleep.duration', 'Sleep.efficiency', 'REM.sleep.percentage', 'Deep.sleep.percentage', 'Light.sleep.percentage'))
```

Looking at this ggpairs graph which only includes the numerical variables, we see that only deep sleep percentage and light sleep percentage are strongly correlated with the response variable (sleep efficiency). Their correlation are 0.800 and -0.829 respectively. 

Almost all the explanatory variables have no significant correlation with each other except deep sleep percentage and light sleep percentage. These two variables have a very strong correlation that is -0.975, and their corresponding scatterplot also exhibits a strong negative linear relationship. This could result in a very problematic issue called collinearity. 

Therefore, we will only include deep sleep percentage as one of the explanatory variables. 

```{r}
sleep_train <- sleep_train |>
  select(-Light.sleep.percentage)
```

Let's start by making a full model regression which includes all the explanatory variables.

```{r}
full_regression <- lm(Sleep.efficiency ~., data = sleep_train)
full_reg_summ <- summary(full_regression)

full_reg_pred <- predict(full_regression, newdata = sleep_test)
sleep_R_MSE_models <- tibble(
  Model = "Full Regression",
  R_MSE = rmse(
    preds = full_reg_pred,
    actual = sleep_test$Sleep.efficiency,
    na.rm = TRUE),
  AIC = AIC(full_regression),
  BIC = BIC(full_regression),
  adjusted_R_sq = full_reg_summ$adj.r.squared)
sleep_R_MSE_models

# Here we compute Root Mean Squared Error so that we can use it as a
# comparison metric between best fit models

```
Now we can begin the forward selection process. We also will compute values of RSS, BIC, and Cp to help decide which sized model is the best fit.

```{r}
sleep_forward_selection <- regsubsets(
  x = Sleep.efficiency ~., nvmax = 11,
  data = sleep_train,
  method = "forward")
sleep_forward_selection

sleep_forward_summary <- summary(sleep_forward_selection)

sleep_forward_summary_df <- tibble(
  n_input_variables = 1:11,
  RSS = sleep_forward_summary$rss,
  BIC = sleep_forward_summary$bic,
  Cp = sleep_forward_summary$cp)

sleep_forward_summary_df
# We can see that the lowest Cp is with 7 variables
summary(sleep_forward_selection)
```
We found that the best model has 7 variables and found which ones from the chart above. Now we can put that into a model and compare it with the original.

```{r}
#make the model with 7 variables
sleep_selected_regression <- lm(Sleep.efficiency ~ Age + REM.sleep.percentage + 
                                  Deep.sleep.percentage + Awakenings + 
                                  Alcohol.consumption + Smoking.status + 
                                  Exercise.frequency, data = sleep_train)
selected_reg_summ <- summary(sleep_selected_regression)

#fit a predicted model
sleep_selected_reg_pred <- predict(sleep_selected_regression, newdata = sleep_test)

#Now we can compare the RMSE on the models
sleep_R_MSE_models <- rbind(
  sleep_R_MSE_models,
  tibble(
    Model = "Selected Regression",
    R_MSE = rmse(
      preds = sleep_selected_reg_pred,
      actuals = sleep_test$Sleep.efficiency,
      na.rm = TRUE),
  AIC = AIC(sleep_selected_regression),
  BIC = BIC(sleep_selected_regression),
  adjusted_R_sq = selected_reg_summ$adj.r.squared))
sleep_R_MSE_models
```
We can further fit a model with interaction terms.

```{r}
sleep_selected_reg_int <- lm(Sleep.efficiency ~ Age * Deep.sleep.percentage + 
                               REM.sleep.percentage + Awakenings + 
                               Alcohol.consumption + Smoking.status + 
                               Exercise.frequency, data = sleep_train)

selected_reg_int_summ <- summary(sleep_selected_reg_int)

#fit a predicted model
sleep_selected_reg_int_pred <- predict(sleep_selected_reg_int, newdata = sleep_test)

#Now we can compare the RMSE on the models
sleep_R_MSE_models <- rbind(
  sleep_R_MSE_models,
  tibble(
    Model = "Selected Regression with Interaction",
    R_MSE = rmse(
      preds = sleep_selected_reg_int_pred,
      actuals = sleep_test$Sleep.efficiency,
      na.rm = TRUE),
  AIC = AIC(sleep_selected_reg_int),
  BIC = BIC(sleep_selected_reg_int),
  adjusted_R_sq = selected_reg_int_summ $adj.r.squared))
sleep_R_MSE_models

```

From here, we can find that the model with the lowest RMSE value gives the best out-of-sample prediction performance. In this example, we can see that the regression model where we selected the variables using forward regression produces a better model. Here we showed that selecting variables helps improve the model, in which we used a forward selection process to find that. We also found that in a model with 7 out of 11 selected variables: Gender, Sleep duration, and Caffeine Consumption were not as helpful in comparison to the other variables when predicting Sleep efficiency- which is an interesting discovery. It helps us to answer our research question which asks which variables are most important. We were surprised to find that caffeine consumption wasn't as important to be kept in the model, as we found many studies when researching that implied the opposite.
